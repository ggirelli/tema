#!/usr/bin/env Rscript

options(echo=TRUE)
args <- commandArgs(trailingOnly = TRUE)

# Check parameters
if(length(args) != 2) stop('./convertToJSON.R session_id config_file')

# Load requirements
library(igraph)
library(rjson)

# Start
if(file.exists(paste0('/home/gire/public_html/SOGIv020/server_side/session/', args[1], '/'))) {
	setwd(paste0('/home/gire/public_html/SOGIv020/server_side/session/', args[1], '/'))
	
	if(file.exists(paste0(args[2], '.json'))) {

		cat('> Read config file\n')
		s <- scan(paste0(args[2], '.json'), 'raw')
		l <- fromJSON(s)
		print(l)

		n_subtrahend_identity <- c()
		e_subtrahend_identity <- c()

		cat('> Start process\n')
		# For each subtrahend network
		for (network in l$networks) {
			# Read network
			g <- read.graph(paste0(network, '.graphml'), format='graphml')
			
			# If there are nodes
			if ( 0 != vcount(g) ) {
				# Build node attribute table
				n_attr_table <- c()
				for (attr in list.vertex.attributes(g)) {
					n_attr_table <- cbind(n_attr_table, eval(parse(text=paste0('V(g)$', attr))))
				}
				colnames(n_attr_table) <- list.vertex.attributes(g)

				# Get attributes for node identity
				n_identity <- c()
				for (attr in names(l$n_identity)) {
					if (as.logical(l$n_identity[attr])) {
						n_identity <- append(n_identity, attr)
					}
				}

				# Expand with missing attributes
				for (attr in c(n_identity, names(l$n_behavior)) ) {
					if ( !attr %in% colnames(n_attr_table) ) {
						n_attr_table <- cbind(n_attr_table, NA)
						colnames(n_attr_table)[ncol(n_attr_table)] <- attr
					}
				}
				
				# Add node identity column
				n_identity_col <- c()
				for (attr in n_identity) {
					if ( 0 == length(n_identity_col) ) {
						n_identity_col <- n_attr_table[,attr]
					} else {
						n_identity_col <- paste0(n_identity_col, '~', n_attr_table[,attr])
					}
				}
				n_attr_table <- cbind(n_attr_table, n_identity_col)
				colnames(n_attr_table)[ncol(n_attr_table)] <- c('sogi_node_identity')

				# Append
				n_subtrahend_identity <- append(n_subtrahend_identity, n_attr_table[,which('sogi_node_identity' == colnames(n_attr_table))])

				# If there are edges
				if ( 0 != ecount(g) ) {
					# Build edge attribute table
					e_attr_table <- c()
					for (attr in list.edge.attributes(g)) {
						e_attr_table <- cbind(e_attr_table, eval(parse(text=paste0('E(g)$', attr))))
					}
					colnames(e_attr_table) <- list.edge.attributes(g)

					# Add source/target
					if ( 'name' %in% list.vertex.attributes(g) ) {
						if ( 'source' %in% colnames(e_attr_table) ) {
							e_attr_table[,'source'] <- n_attr_table[unlist(lapply(get.edgelist(g)[,1], FUN=function(x,g) {return(c(V(g)[name==x]))}, g)), 'sogi_node_identity']
						} else {
							e_attr_table <- cbind(e_attr_table, n_attr_table[unlist(lapply(get.edgelist(g)[,1], FUN=function(x,g) {return(c(V(g)[name==x]))}, g)), 'sogi_node_identity'])
							colnames(e_attr_table)[ncol(e_attr_table)] <- 'source'
						}
						if ( 'target' %in% colnames(e_attr_table) ) {
							e_attr_table[,'target'] <- n_attr_table[unlist(lapply(get.edgelist(g)[,2], FUN=function(x,g) {return(c(V(g)[name==x]))}, g)), 'sogi_node_identity']
						} else {
							e_attr_table <- cbind(e_attr_table, n_attr_table[unlist(lapply(get.edgelist(g)[,2], FUN=function(x,g) {return(c(V(g)[name==x]))}, g)), 'sogi_node_identity'])
							colnames(e_attr_table)[ncol(e_attr_table)] <- 'target'
						}
					} else {
						if ( 'source' %in% colnames(e_attr_table) ) {
							e_attr_table[,'source'] <- n_attr_table[unlist(lapply(get.edgelist(g)[,1], FUN=function(x,g) {return(c(V(g)[id==x]))}, g)), 'sogi_node_identity']
						} else {
							e_attr_table <- cbind(e_attr_table, n_attr_table[unlist(lapply(get.edgelist(g)[,1], FUN=function(x,g) {return(c(V(g)[id==x]))}, g)), 'sogi_node_identity'])
							colnames(e_attr_table)[ncol(e_attr_table)] <- 'source'
						}
						if ( 'target' %in% colnames(e_attr_table) ) {
							e_attr_table <- n_attr_table[unlist(lapply(get.edgelist(g)[,2], FUN=function(x,g) {return(c(V(g)[id==x]))}, g)), 'sogi_node_identity']
						} else {
							e_attr_table[,'target'] <- cbind(e_attr_table, n_attr_table[unlist(lapply(get.edgelist(g)[,2], FUN=function(x,g) {return(c(V(g)[id==x]))}, g)), 'sogi_node_identity'])
							colnames(e_attr_table)[ncol(e_attr_table)] <- 'target'
						}
					}

					# Get attributes for edge identity
					e_identity <- c()
					for (attr in names(l$e_identity)) {
						if (as.logical(l$e_identity[attr])) {
							e_identity <- append(e_identity, attr)
						}
					}

					# Expand with missing attributes
					for (attr in c(e_identity, names(l$e_behavior)) ) {
						if ( !attr %in% colnames(e_attr_table) ) {
							e_attr_table <- cbind(e_attr_table, NA)
							colnames(e_attr_table)[ncol(e_attr_table)] <- attr
						}
					}

					# Add edge identity column
					e_identity_col <- paste0(e_attr_table[,'source'], '->', e_attr_table[,'target'])
					for (attr in e_identity) {
						if ( 0 == length(e_identity_col) ) {
							e_identity_col <- e_attr_table[,attr]
						} else {
							e_identity_col <- paste0(e_identity_col, '~', e_attr_table[,attr])
						}
					}
					e_attr_table <- cbind(e_attr_table, e_identity_col)
					colnames(e_attr_table)[ncol(e_attr_table)] <- c('sogi_edge_identity')

					# Append
					e_subtrahend_identity <- append(e_subtrahend_identity, e_attr_table[,which('sogi_edge_identity' == colnames(e_attr_table))])
				}
			}
		}

		# Work on the minuend network
		# Read network
		g <- read.graph(paste0(l$minuend, '.graphml'), format='graphml')
		# If there are nodes
		if ( 0 != vcount(g) ) {
			# Build node attribute table
			n_minuend_attr_table <- c()
			for (attr in list.vertex.attributes(g)) {
				n_minuend_attr_table <- cbind(n_minuend_attr_table, eval(parse(text=paste0('V(g)$', attr))))
			}
			colnames(n_minuend_attr_table) <- list.vertex.attributes(g)

			# Get attributes for node identity
			n_identity <- c()
			for (attr in names(l$n_identity)) {
				if (as.logical(l$n_identity[attr])) {
					n_identity <- append(n_identity, attr)
				}
			}

			# Expand with missing attributes
			for (attr in c(n_identity, names(l$n_behavior)) ) {
				if ( !attr %in% colnames(n_minuend_attr_table) ) {
					n_minuend_attr_table <- cbind(n_minuend_attr_table, NA)
					colnames(n_minuend_attr_table)[ncol(n_minuend_attr_table)] <- attr
				}
			}
			
			# Add node identity column
			n_identity_col <- c()
			for (attr in n_identity) {
				if ( 0 == length(n_identity_col) ) {
					n_identity_col <- n_minuend_attr_table[,attr]
				} else {
					n_identity_col <- paste0(n_identity_col, '~', n_minuend_attr_table[,attr])
				}
			}
			n_minuend_attr_table <- cbind(n_minuend_attr_table, n_identity_col)
			colnames(n_minuend_attr_table)[ncol(n_minuend_attr_table)] <- c('sogi_node_identity')

			# Sort node attribute table
			n_minuend_attr_table <- n_minuend_attr_table[,order(colnames(n_minuend_attr_table))]

			# If there are edges
			if ( 0 != ecount(g) ) {
				# Build edge attribute table
				e_minuend_attr_table <- c()
				for (attr in list.edge.attributes(g)) {
					e_minuend_attr_table <- cbind(e_minuend_attr_table, eval(parse(text=paste0('E(g)$', attr))))
				}
				colnames(e_minuend_attr_table) <- list.edge.attributes(g)

				# Add source/target
				if ( 'name' %in% list.vertex.attributes(g) ) {
					if ( 'source' %in% colnames(e_attr_table) ) {
						e_attr_table[,'source'] <- n_attr_table[unlist(lapply(get.edgelist(g)[,1], FUN=function(x,g) {return(c(V(g)[name==x]))}, g)), 'sogi_node_identity']
					} else {
						e_attr_table <- cbind(e_attr_table, n_attr_table[unlist(lapply(get.edgelist(g)[,1], FUN=function(x,g) {return(c(V(g)[name==x]))}, g)), 'sogi_node_identity'])
						colnames(e_attr_table)[ncol(e_attr_table)] <- 'source'
					}
					if ( 'target' %in% colnames(e_attr_table) ) {
						e_attr_table[,'target'] <- n_attr_table[unlist(lapply(get.edgelist(g)[,2], FUN=function(x,g) {return(c(V(g)[name==x]))}, g)), 'sogi_node_identity']
					} else {
						e_attr_table <- cbind(e_attr_table, n_attr_table[unlist(lapply(get.edgelist(g)[,2], FUN=function(x,g) {return(c(V(g)[name==x]))}, g)), 'sogi_node_identity'])
						colnames(e_attr_table)[ncol(e_attr_table)] <- 'target'
					}
				} else {
					if ( 'source' %in% colnames(e_attr_table) ) {
						e_attr_table[,'source'] <- n_attr_table[unlist(lapply(get.edgelist(g)[,1], FUN=function(x,g) {return(c(V(g)[id==x]))}, g)), 'sogi_node_identity']
					} else {
						e_attr_table <- cbind(e_attr_table, n_attr_table[unlist(lapply(get.edgelist(g)[,1], FUN=function(x,g) {return(c(V(g)[id==x]))}, g)), 'sogi_node_identity'])
						colnames(e_attr_table)[ncol(e_attr_table)] <- 'source'
					}
					if ( 'target' %in% colnames(e_attr_table) ) {
						e_attr_table <- n_attr_table[unlist(lapply(get.edgelist(g)[,2], FUN=function(x,g) {return(c(V(g)[id==x]))}, g)), 'sogi_node_identity']
					} else {
						e_attr_table[,'target'] <- cbind(e_attr_table, n_attr_table[unlist(lapply(get.edgelist(g)[,2], FUN=function(x,g) {return(c(V(g)[id==x]))}, g)), 'sogi_node_identity'])
						colnames(e_attr_table)[ncol(e_attr_table)] <- 'target'
					}
				}

				# Get attributes for edge identity
				e_identity <- c()
				for (attr in names(l$e_identity)) {
					if (as.logical(l$e_identity[attr])) {
						e_identity <- append(e_identity, attr)
					}
				}

				# Expand with missing attributes
				for (attr in c(e_identity, names(l$e_behavior)) ) {
					if ( !attr %in% colnames(e_minuend_attr_table) ) {
						e_minuend_attr_table <- cbind(e_minuend_attr_table, NA)
						colnames(e_minuend_attr_table)[ncol(e_minuend_attr_table)] <- attr
					}
				}

				# Expand with missing attributes
				for (attr in c(e_identity, names(l$e_behavior)) ) {
					if ( !attr %in% colnames(e_minuend_attr_table) ) {
						e_minuend_attr_table <- cbind(e_minuend_attr_table, NA)
						colnames(e_minuend_attr_table)[ncol(e_minuend_attr_table)] <- attr
					}
				}

				# Add edge identity column
				e_identity_col <- paste0(e_minuend_attr_table[,'source'], '->', e_minuend_attr_table[,'target'])
				for (attr in e_identity) {
					if ( 0 == length(e_identity_col) ) {
						e_identity_col <- e_minuend_attr_table[,attr]
					} else {
						e_identity_col <- paste0(e_identity_col, '~', e_minuend_attr_table[,attr])
					}
				}
				e_minuend_attr_table <- cbind(e_minuend_attr_table, e_identity_col)
				colnames(e_minuend_attr_table)[ncol(e_minuend_attr_table)] <- c('sogi_edge_identity')

				# Sort edge attribute table
				e_minuend_attr_table <- e_minuend_attr_table[,order(colnames(e_minuend_attr_table))]
			}
		}

		# Subtract
		n_minuend <- n_minuend_attr_table
		n_minuend <- n_minuend[-which(n_minuend[,which('sogi_node_identity' == colnames(n_minuend))] %in% n_subtrahend_identity),]
		e_minuend <- e_minuend_attr_table
		e_minuend <- e_minuend[-which(e_minuend[,which('sogi_edge_identity' == colnames(e_minuend))] %in% e_subtrahend_identity),]

		# Convert source/target in node IDs
		e_minuend[,'source'] <- unlist(lapply(e_minuend[,'source'], FUN=function (x, nlist) { id <- which(nlist == x); if(0 == length(id)) id <- NA; return(id); }, nlist=n_minuend[,which('sogi_node_identity' == colnames(n_minuend))]))
		e_minuend[,'target'] <- unlist(lapply(e_minuend[,'target'], FUN=function (x, nlist) { id <- which(nlist == x); if (0 == length(id)) id <- NA; return(id); }, nlist=n_minuend[,which('sogi_node_identity' == colnames(n_minuend))]))
		# Remove NAs
		e_minuend <- e_minuend[-which(is.na(e_minuend[,'source'])),]
		e_minuend <- e_minuend[-which(is.na(e_minuend[,'target'])),]

		# Remove identity columns
		n_minuend <- n_minuend[, -which('sogi_node_identity' == colnames(n_minuend))]
		e_minuend <- e_minuend[, -which('sogi_edge_identity' == colnames(e_minuend))]

		cat('> Convert to graph\n')
		g.out <- graph.empty()
		g.out <- add.vertices(g.out, nrow(n_minuend))
		for (attr in colnames(n_minuend)) {
			eval(parse(text=paste0('V(g.out)$', attr, ' <- n_minuend[, attr]')))
		}
		g.out <- add.edges(g.out, c(rbind(V(g.out)[as.numeric(e_minuend[,'source'])],V(g.out)[as.numeric(e_minuend[,'target'])])))
		for (attr in colnames(e_minuend)) {
			eval(parse(text=paste0('E(g.out)$', attr, ' <- e_minuend[, attr]')))
		}

		cat('> Write GraphML network\n')
		write.graph(g.out, paste0(l$new_name, '.graphml'), format='graphml')

		cat('> Preparing config file.\n')
		d <- list(e_attributes=list.edge.attributes(g.out), e_count=ecount(g.out), v_attributes=list.vertex.attributes(g.out), v_count=vcount(g.out))

		cat('> Writing DAT file.\n')		
		write(toJSON(d), paste0(l$new_name, '.dat'))

		cat('> Writing JSON file.\n')
		source('../../Rscripts/extendIgraph.R')
		write.graph(g.out, paste0(l$new_name, '.json'), format='json')

		cat('> Converted.\n')

		cat('~ END ~')
	}
}